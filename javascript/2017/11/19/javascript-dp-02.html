<!DOCTYPE html>
<html lang="zh-CN">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta content="telephone=no" name="format-detection" />
  <link rel="shortcut icon" type="image/x-icon" href="/assets/images/site/favicon.ico">
  <title>喵~沽酒处</title>
  <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="/assets/css/main.css">


</head>
<body>
  <div class="container">
    <header id="header">
  <div class="head-line"></div>
<progress value="0" id="head-progress" class="flat"></progress>
  <div id="head-title"><a href="/">LEONMIN</a></div>
  <div class="head-brand">
    <div id="head-back">
      <i class="fa fa-chevron-left"></i>
    </div>
    <div id="head-search">
      <div id="head-search-btn">
  <i class="fa fa-search"></i>
</div>
<div id="head-mask"></div>
<div id="head-search-contain">
  <div class="search">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <div class="search-input-wrapper">
      <input type="text" id="search-input" placeholder="Searching.." class="search-input">
    </div>
    <span class="search-close-icon">
      <i class="fa fa-times-circle-o"></i>
    </span>
  </div>
  <div class="search-result">
    <div id="results-container"></div>
  </div>
</div>
    </div>
    <div id="head-menu">
      <div class="head-menu-btn">
    <p class="drawer-hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </p>
  </div>
<nav id="head-menu-contain">
  <h2>MENU</h2>
  <ul class="site-ham-list">
    <li>
      <a href="/">LIMI</a>
    </li>
    <li>
      <a href="/archive/">ARCHIVE</a>
    </li>
    <li>
      <a href="/tags/">TAGS</a>
    </li>
    <li>
      <a href="/about/">ABOUT</a>
    </li>
  </ul>
  <dl class="site-ham-item">
    <dt>TEL</dt>
    <dd>
      <a href="tel:097-547-9781">Tel.184-8360-0000</a>
    </dd>
    <dt>CONNECT</dt>
    <div class="aside-content">
      <span>
        <a href="http://weibo.com/leonmin" target="_blank">
          <i class="fa fa-weibo fa-3x"></i>
        </a>
      </span>
      <span>
        <a href="https://github.com/leonmin" target="_blank">
          <i class="fa fa-github fa-3x"></i>
        </a>
      </span>
      <span>
        <a href="https://twitter.com/leonminnn" target="_blank">
          <i class="fa fa-twitter fa-3x"></i>
        </a>
      </span>
      <span>
        <a href=" /feed.xml ">
          <i class="fa fa-rss fa-3x"></i>
        </a>
      </span>
    </div>
  </dl>
</nav>

    </div>
  </div>
</header>
    <main class="main">
      
<section id="posts">
    
    <article class="post">
  <header class="post-header">
    <h1 class="post-h-title">
      <a href="/javascript/2017/11/19/javascript-dp-02.html">JavaScript设计模式--策略模式</a>
    </h1>
    <div class="post-meta">
        <span class="post-date">2017年11月19日</span>
        <span class="post-cate"><a href="/category/javascript/" title="Javascript">Javascript</a></span>
      </div>
  </header>
  <section class="post-content">
    <p>策略模式的定义是: <strong>定义一系列的算法,把它们一个个封装起来,并且使它们可以相互替换.</strong></p>

<h4 id="1-使用策略模式计算奖金">1. 使用策略模式计算奖金</h4>

<p>需求:绩效为S的人年终奖有4倍工资,绩效为A的人年终奖有3倍工资,而绩效为B的人年终奖有2倍工资.</p>

<p>(1) 最初的代码实现:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">calculateBonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">performanceLevel</span><span class="p">,</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">performanceLevel</span><span class="o">===</span><span class="s1">'S'</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">performanceLevel</span><span class="o">===</span><span class="s1">'A'</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">performanceLevel</span><span class="o">===</span><span class="s1">'B'</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">calculateBonus</span><span class="p">(</span><span class="s1">'B'</span><span class="p">,</span><span class="mi">20000</span><span class="p">);</span>  <span class="c1">//40000</span>
<span class="nx">calculateBonus</span><span class="p">(</span><span class="s1">'S'</span><span class="p">,</span><span class="mi">6000</span><span class="p">);</span> <span class="c1">//24000 </span>
</code></pre></div></div>

<!-- more -->

<p>这段代码有很多缺点:</p>

<p>  1° calculateBonus函数比较庞大;</p>

<p>  2° calculateBonus函数缺乏弹性,修改时需要深入calculateBonus函数的内部实现,这违反了开放-封闭原则;</p>

<p>  3° 算法的复用性差.</p>

<p>(2) 使用组合函数重构代码:</p>

<p>将各种算法封装到一个个的小函数里面,小函数有良好的命名,很清楚对应哪种算法,也可以被复用.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">performanceS</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">...</span>
<span class="kd">var</span> <span class="nx">calculateBonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">performanceLevel</span><span class="p">,</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">performanceLevel</span><span class="o">===</span><span class="s1">'S'</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">performanceS</span><span class="p">(</span><span class="nx">salary</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这段代码使得函数变得庞大,且系统变化时缺乏弹性.</p>

<p>(3) 使用策略模式重构代码:</p>

<p>策略模式的目的就是将算法的使用与算法的实现分离开来.</p>

<p>一个基于策略模式的程序至少由两部分组成:</p>

<p>  1° 一组策略类: 封装了具体的算法,并负责具体的计算过程;</p>

<p>  2° 环境类Context: 接受客户的请求,随后将请求委托给某一个策略类.</p>

<p>要做到说明Context中要维持对某个策略对象的引用.</p>

<p>通过传统面向对象语言来实现:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">performanceS</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span>
<span class="nx">performanceS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">calculate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="c1">//定义奖金类Bonus</span>
<span class="kd">var</span> <span class="nx">Bonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">salary</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">strategy</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">Bonus</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setSalary</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">salary</span> <span class="o">=</span> <span class="nx">salary</span><span class="p">;</span> <span class="c1">//设置员工的原始工资</span>
<span class="p">};</span>
<span class="nx">Bonus</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setStrategy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">strategy</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">strategy</span> <span class="o">=</span> <span class="nx">strategy</span><span class="p">;</span>  <span class="c1">//设置员工绩效等级对应的策略对象</span>
<span class="p">};</span>
<span class="nx">Bonus</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getBonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span><span class="c1">//获取奖金数额</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">strategy</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">salary</span><span class="p">);</span><span class="c1">//把计算奖金的操作委托给对应的策略对象</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">bonus</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bonus</span><span class="p">();</span>
<span class="nx">bonus</span><span class="p">.</span><span class="nx">setSalary</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
<span class="nx">bonus</span><span class="p">.</span><span class="nx">setStrategy</span><span class="p">(</span><span class="k">new</span> <span class="nx">performanceS</span><span class="p">());</span><span class="c1">//设置策略对象</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bonus</span><span class="p">.</span><span class="nx">getBonus</span><span class="p">());</span> <span class="c1">//40000</span>
</code></pre></div></div>
<h4 id="2-javascript版本的策略模式">2. JavaScript版本的策略模式</h4>

<p>在JavaScript语言中,函数也是对象,因此将strategy直接定义为函数,用calculateBonus函数来充当Context来接受用户的请求.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">strategies</span><span class="o">=</span><span class="p">{</span>
  <span class="s2">"S"</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="s2">"A"</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="s2">"B"</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">calculateBonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">strategies</span><span class="p">[</span><span class="nx">level</span><span class="p">](</span><span class="nx">salary</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">calculateBonus</span><span class="p">(</span><span class="s1">'S'</span><span class="p">,</span><span class="mi">20000</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">calculateBonus</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span><span class="mi">10000</span><span class="p">));</span>
</code></pre></div></div>

<h4 id="3-多态在策略模式中的体现">3. 多态在策略模式中的体现</h4>

<p>每个策略对象负责的算法已经被各自封装在对象内部,当对这些策略对象发出计算请求时,它们会返回各自的不同的计算结果,这正是多态性的体现,也是”它们可以相互替换”的目的.替换Context中当前保存的策略对象,便能执行不同的算法来得到我们想要的结果.</p>

<h4 id="4-使用策略模式实现缓动动画">4. 使用策略模式实现缓动动画</h4>

<p>(1) 实现动画效果的原理:</p>

<p>在JavaScript中,可以通过连续改变元素的某个CSS属性,比如left,top,background-position来实现动画效果.</p>

<p>(2) 思路和一些准备:</p>

<p>分析实现这个程序的思路,提前记录:</p>

<p>  1° 动画开始时,小球所在的原始位置;</p>

<p>  2° 小球移动的目标位置;</p>

<p>  3° 动画开始时的准确时间点;</p>

<p>  4° 小球运动的持续时间;</p>

<p>随后使用setInterval创建一个定时器,每隔19ms循环一次.在定时器的每一帧里我们将动画消耗的时间,小球原始位置等信息传入缓动算法.算法通过参数计算出小球当前所在位置,最后更新该div对应CSS属性,小球就能顺利运动起来.</p>

<p>(3) 让小球运动起来:</p>

<p>常见的缓动算法接受4个参数:动画已消耗的时间,小球原始位置,小球目标位置,动画持续的总时间,返回值时动画元素应处的当前位置:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">tween</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">linear</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">+</span> <span class="nx">b</span>
  <span class="p">},</span>
  <span class="na">easeIn</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span> <span class="nx">t</span> <span class="o">/=</span> <span class="nx">d</span> <span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">b</span>
  <span class="p">},</span>
  <span class="na">strongEaseIn</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span> <span class="nx">t</span> <span class="o">/=</span> <span class="nx">d</span> <span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="na">strongEaseOut</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="na">sineaseIn</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span> <span class="p">){</span>
    <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span> <span class="nx">t</span> <span class="o">/=</span> <span class="nx">d</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">},</span>
  <span class="na">sineaseOut</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>参考jQuery库实现动画:</p>

<p>  1° 创建div:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"position:absolute;background:blue"</span> <span class="na">id=</span><span class="s">"div"</span><span class="nt">&gt;</span>
  我是div
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>
<p>  2° 定义Animate类,接受一个参数:即将运动起来的dom节点.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Animate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dom</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">;</span><span class="c1">//进行运动的dom节点</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//运动开始的时间</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">startPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//动画开始时,dom节点的位置</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//动画结束时,dom节点的位置</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">propertyName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="c1">//dom节点需要被改变的css属性名</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">easing</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="c1">//缓动算法</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="c1">//动画持续时间</span>
<span class="p">};</span>
</code></pre></div></div>
<p>  3° Animate.prototype.start 方法:在动画被启动的瞬间,要记录一些信息,供缓动算法计算.并启动定时器:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">propertyName</span><span class="p">,</span><span class="nx">endPos</span><span class="p">,</span><span class="nx">duration</span><span class="p">,</span><span class="nx">easing</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span><span class="c1">//动画启动时间</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">startPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">()[</span><span class="nx">propertyName</span><span class="p">];</span><span class="c1">//dom节点初始位置</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">propertyName</span> <span class="o">=</span> <span class="nx">propertyName</span><span class="p">;</span><span class="c1">//dom节点需要被改变的CSS属性名</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">endPos</span> <span class="o">=</span> <span class="nx">endPos</span><span class="p">;</span><span class="c1">//dom节点目标位置</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">duration</span><span class="p">;</span><span class="c1">//动画持续时间</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">easing</span> <span class="o">=</span> <span class="nx">tween</span><span class="p">[</span><span class="nx">easing</span><span class="p">];</span><span class="c1">//缓动算法</span>
  <span class="kd">var</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">timeId</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="c1">//启动定时器</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">step</span><span class="p">()</span><span class="o">===</span><span class="kc">false</span><span class="p">){</span><span class="c1">//如果动画已结束,则清楚定时器</span>
      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timeId</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span><span class="mi">19</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Animate.prototype.start接受以下4个参数:</p>

<p>   ① propertyName: 要改变的CSS属性名;</p>

<p>   ② endPos: 小球运动的目标位置;</p>

<p>   ③ duration: 动画持续时间;</p>

<p>   ④ easing: 缓动算法.</p>

<p>  4°  Animate.prototype.step 方法:代表小球每一帧要做的事情.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span><span class="c1">//取得当前时间</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">t</span><span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">duration</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">endPos</span><span class="p">);</span><span class="c1">//更新小球的CSS属性值</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">easing</span><span class="p">(</span><span class="nx">t</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">startPos</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">endPos</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">startPos</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span><span class="c1">//pos为小球当前位置</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span><span class="c1">//更新小球的CSS属性值</span>
<span class="p">};</span>
</code></pre></div></div>
<p>  5°  Animate.prototype.update 方法:更新小球CSS属性:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<p>  6°  测试代码:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">animate</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Animate</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
<span class="nx">animate</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">'left'</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="s1">'strongEaseOut'</span><span class="p">);</span>
</code></pre></div></div>
<h4 id="5-更广义的算法">5. 更广义的”算法”</h4>

<p>从定义上来看,策略模式就是用来封装算法的.策略模式也可以用来封装一系列的”业务规则”.只要这些业务规则指向的目标一致,并且可以被替换使用,就可以用策略模式来封装它们.</p>

<h4 id="6-表单校验">6. 表单校验</h4>

<p>(1) 表单校验的第一个版本:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://xxx.com/register"</span> <span class="na">id=</span><span class="s">"registerForm"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
      请输入用户名:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"userName"</span> <span class="nt">/&gt;</span>
      请输入密码:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
      请输入手机号码:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"phoneNumber"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;button&gt;</span>提交<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;script&gt;</span>
    <span class="kd">var</span> <span class="nx">registerForm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'registerForm'</span><span class="p">);</span>
      <span class="nx">registerForm</span><span class="p">.</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">userName</span><span class="p">.</span><span class="nx">value</span><span class="o">===</span><span class="s1">''</span><span class="p">){</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'用户名不能为空'</span><span class="p">);</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">password</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">){</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'密码长度不能少于6位'</span><span class="p">);</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="sr">/</span><span class="se">(</span><span class="sr">^1</span><span class="se">[</span><span class="sr">3|5|8</span><span class="se">][</span><span class="sr">0-9</span><span class="se">]{9}</span><span class="sr">$</span><span class="se">)</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">registerForm</span><span class="p">.</span><span class="nx">phoneNumber</span><span class="p">.</span><span class="nx">value</span> <span class="p">)){</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'手机号码格式不正确'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>(2) 使用策略模式重构表单校验</p>

<p>  1° 将校验逻辑封装成<strong>策略对象</strong>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">strategies</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">isNonEmpty</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">errorMsg</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">===</span><span class="s1">''</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">errorMsg</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">minLength</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">length</span><span class="p">,</span><span class="nx">errorMsg</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">errorMsg</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">isMobile</span><span class="p">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">errorMsg</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="sr">/</span><span class="se">(</span><span class="sr">^1</span><span class="se">[</span><span class="sr">3|5|8</span><span class="se">][</span><span class="sr">0-9</span><span class="se">](</span><span class="sr">9</span><span class="se">)</span><span class="sr">$</span><span class="se">)</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">value</span><span class="p">)){</span>
      <span class="k">return</span> <span class="nx">errorMsg</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<p>  2° <strong>客户调用代码</strong>,这里作为Context,负责接收用户的请求并委托给strategy对象.先了解用户是如何向Validator类发送请求的:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">validataFunc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">validator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Validator</span><span class="p">();</span><span class="c1">//创建一个validator对象</span>
  <span class="nx">validator</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">userName</span><span class="p">,</span><span class="s1">'isNonEmpty'</span><span class="p">,</span><span class="s1">'用户名不能为空'</span><span class="p">);</span>
  <span class="nx">validator</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="s1">'minLength:6'</span><span class="p">,</span><span class="s1">'密码长度不能少于6位'</span><span class="p">);</span>
  <span class="nx">validator</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">phoneNumber</span><span class="p">,</span><span class="s1">'isMobile'</span><span class="p">,</span><span class="s1">'手机号码格式不正确'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">errorMsg</span> <span class="o">=</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span><span class="c1">//获取校验结果</span>
  <span class="k">return</span> <span class="nx">errorMsg</span><span class="p">;</span><span class="c1">//返回校验错误</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">registerForm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'registerForm'</span><span class="p">);</span>
<span class="nx">registerForm</span><span class="p">.</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">errorMsg</span> <span class="o">=</span> <span class="nx">validataFunc</span><span class="p">();</span><span class="c1">//如果有errorMsg有确切返回值,说明未通过校验</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">errorMsg</span><span class="p">){</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">errorMsg</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span><span class="c1">//阻止表单提交</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<p>  3° <strong>Validator类</strong>的实现:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Validator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="o">=</span><span class="p">[];</span><span class="c1">//保存校验规则</span>
<span class="p">};</span>
<span class="nx">Validator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dom</span><span class="p">,</span><span class="nx">rule</span><span class="p">,</span><span class="nx">errorMsg</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">ary</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">);</span><span class="c1">//把strategy和参数分开</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="c1">//把校验的步骤用空函数包装起来,并放入cache</span>
    <span class="kd">var</span> <span class="nx">strategy</span> <span class="o">=</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span><span class="c1">//用户挑选的strategy</span>
    <span class="nx">ary</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span><span class="c1">//把input的value添加进参数列表</span>
    <span class="nx">ary</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">errorMsg</span><span class="p">);</span><span class="c1">//把errorMsg添加进参数列表</span>
    <span class="k">return</span> <span class="nx">strategies</span><span class="p">[</span><span class="nx">strategy</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">dom</span><span class="p">,</span><span class="nx">ary</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">Validator</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="nx">validatorFunc</span><span class="p">;</span><span class="nx">validatorFunc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];){</span>
    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">validatorFunc</span><span class="p">();</span><span class="c1">//开始校验,并取得校验后 的返回信息</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span><span class="c1">//如果有确切返回信息,说明校验没通过</span>
      <span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>
<p>  4° 给文本输入框添加多种校验规则:</p>

<p>修改客户调用代码:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">registerForm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'registerForm'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ValidataFunc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">validator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Validator</span><span class="p">();</span>
  <span class="nx">validator</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">userName</span><span class="p">,[{</span>
    <span class="na">strategy</span><span class="p">:</span> <span class="s1">'isNonEmpty'</span><span class="p">,</span>
    <span class="na">errorMsg</span><span class="p">:</span> <span class="s1">'用户名不能为空'</span>
  <span class="p">},{</span>
    <span class="na">strategy</span><span class="p">:</span> <span class="s1">'minLength:6'</span><span class="p">,</span>
    <span class="na">errorMsg</span><span class="p">:</span> <span class="s1">'用户名长度不能小于6'</span>
  <span class="p">}]);</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="7-策略模式的优缺点">7. 策略模式的优缺点</h4>

<p>(1) 策略模式利用组合,委托和多态等技术和思想,可以有效地避免多重条件选择语句;</p>

<p>(2) 策略模式提供了对开放-封闭原则的完美支持,将算法封装在独立的strategy中,使它易于切换,易于理解,易于扩展.</p>

<p>(3) 策略模式的算法也可以复用在系统其它地方;</p>

<p>(4) 在策略模式中利用组合和委托来让Context拥有执行算法的能力,这也是继承的一种更轻便的替代方案.</p>

<h4 id="8-一等函数对象和策略模式">8. 一等函数对象和策略模式</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">S</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">A</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">B</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">salary</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">calculateBonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span><span class="nx">salary</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">func</span><span class="p">(</span><span class="nx">salary</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">calculateBonus</span><span class="p">(</span><span class="nx">S</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="9-小结">9. 小结</h4>

<p>在JavaScript语言的策略模式中,策略往往被函数所代替,这是策略模式就成为一种”隐形”的模式.</p>

  </section>
  <footer class="post-footer">
    
<div class="post-f-nav" id="post-nav-id">
  <div class="post-f-nav-next post-f-nav-item">
    
    <a href="/ruby/2017/11/19/ruby-on-rails-01.html" rel="next" title="Ruby on Rails(从零开始)">
      <i class="fa fa-chevron-left"></i> Ruby on Rails(从零开始)
    </a>
    
  </div>
  <span class="post-nav-divider"></span>
  <div class="post-f-nav-prev post-f-nav-item">
    
    <a href="/javascript/2017/11/19/javascript-dp-01.html" rel="prev" title="JavaScript设计模式--单例模式">
      JavaScript设计模式--单例模式
      <i class="fa fa-chevron-right"></i>
    </a>
    
  </div>
</div>

  </footer>
</article>
</section>


    </main>
    <footer id="footer">
  <div class="move-btn">
	<div class="move-con">
		<div class="circleProgress_wrapper">
			<div class="wrapper right">
				<div class="circleProgress rightcircle"></div>
			</div>
			<div class="wrapper left">
				<div class="circleProgress leftcircle"></div>
			</div>
		</div>
		<div class="circle"></div>
		<div class="arrow arrow-hit">
			<i class="fa fa-lg fa-chevron-down"></i>
		</div>
	</div>
</div>
  <div class="contact-list">
    <div class="contact">
      <a target="_blank" href="https://weibo.com/leonmin"><i class="fa fa-weibo"></i></a>
      <a target="_blank" href="https://github.com/leonmin"><i class="fa fa-github"></i></a>
      <a target="_blank" href="https://twitter.com/leonminnn"><i class="fa fa-twitter"></i></a>
      <a target="_blank" href="https://www.instagram.com/leonminnn"><i class="fa fa-instagram"></i></a>
    </div>
    <div class="friend-link">
      <a target="_blank" href="https://jekyllrb.com/"><img src="/assets/images/site/jekyll-logo.png" alt="jekyll"></a>
      <a target="_blank" href="https://leonm.in" title="喵呜~"><img class="friend-link-site" src="/assets/images/site/limi.png" alt="limi"></a>
    </div>
  </div>
</footer>
  </div>
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/simple-jekyll-search.js"></script>
  <script src="/assets/js/limon.js"></script>
</body>
</html>